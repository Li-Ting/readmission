<!DOCTYPE html>
<html lang="en">
<head>
    <title>dc.js - Pie Chart Example</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="dc.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js" type="text/javascript"></script>

<style>
table {
    border-collapse: collapse;
    width: 100%;
}

th, td {
    text-align: left;
    padding: 8px;
}

tr:nth-child(even){background-color: #f2f2f2}

th {
    background-color: #77DDFF;
    color: white;
}


</style>
</head>
<body>
<div class="header">
<h1>Readitted Rate</h1>
</div>
<hr>

<script type="text/javascript" src="d3.js"></script>
<script type="text/javascript" src="crossfilter.js"></script>
<script type="text/javascript" src="dc.js"></script>
<div class ="level1">
<div id="sexType">
    <strong>Sex Type</strong>
    <a class="reset" href="javascript:sexTypechart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
    <div class="clearfix"></div>
  </div>

<div id="divisionType">
    <strong>Division Type</strong>
    <a class="reset" href="javascript:divisionTypechart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
    <div class="clearfix"></div>
  </div>

<div id="dayType">
    <strong>Days</strong>
    <a class="reset" href="javascript:dayTypechart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
    <div class="clearfix"></div>
  </div>

<div id="chart-line-hitsperday">
  <strong>Readmission_Rate</strong>
    <span class="reset" style="display: none;">Selected: <span class="filter"></span></span>
    <a class="reset" href="javascript:hitslineChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
    <div class="clearfix"></div>
</div>
<div style='clear:both;'>
    <table id="dc-data-table">
      <thead>
      <tr class="data_table">
        <th>Day</th>
        <th>Readmission</th>
        <th>Discharge</th>
        <th>Rate</th>
      </tr>
      </thead>
    </table>
</div> 

<script type="text/javascript">

var sexTypechart = dc.pieChart("#sexType");
var divisionTypechart = dc.rowChart("#divisionType");
var dayTypechart = dc.rowChart("#dayType");
var hitslineChart  = dc.lineChart("#chart-line-hitsperday"); 
d3.csv("data.csv", function(error, data){

  if (error) throw error;

      var  ndx = crossfilter(data);
      var all = ndx.groupAll();

      var sexDimension  = ndx.dimension(function(d) {return d["Sex"];})
      var sexSumGroup = sexDimension.group().reduceSum(function(d) {return d.Readmission / d.Discharge;});


      var divTypeDim = ndx.dimension(function (d) { return d["Division"]; });
      var divTypeGroup = divTypeDim.group().reduceSum(function(d) {return d.Readmission / d.Discharge;});

      var dayTypeDim = ndx.dimension(function (d) { return d["Days"]; });
      var dayTypeGroup = dayTypeDim.group().reduceSum(function(d) {return d.Readmission / d.Discharge;});

      /*line chart*/
      var parseDate = d3.time.format("%m/%d/%Y").parse;
      var numberFormat = d3.format(".2f");
      data.forEach(function(d) {
        d.date = parseDate(d.date);
        d.Rate= (d.Readmission/d.Discharge) * 100;
        d.Year=d.date.getFullYear();
      });

      var dateDim = ndx.dimension(function(d) {return d.date;});
      var hits = dateDim.group().reduceSum(function(d) {return d.Rate;}); 
      var minDate = dateDim.bottom(1)[0].date;
      var maxDate = dateDim.top(1)[0].date;
      var yearDim  = ndx.dimension(function(d) {return +d.Year;});
      var year_Rate = yearDim.group().reduceSum(function(d) {return d.Rate;});

      var status_Re=dateDim.group().reduceSum(function(d) {return d.Readmission;});
      var status_Dis=dateDim.group().reduceSum(function(d) {return d.Discharge;});

    sexTypechart
      .width(300)
      .height(300)
      .slicesCap(2)
      .innerRadius(50)
      .ordinalColors(["#56B2EA","#E064CD"])
      .dimension(sexDimension)
      .group(sexSumGroup)
      .legend(dc.legend())
      // workaround for #703: not enough data is accessible through .label() to display percentages
      .on('pretransition', function(chart) {
          chart.selectAll('text.pie-slice').text(function(d) {
              return d.data.key + ' ' + dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2*Math.PI) * 100) + '%';
          })
      });
  //sexTypechart.render();


    divisionTypechart
      .width(300)
      .height(300)
      .ordinalColors(["#56B2EA","#E064CD","#F8B700","#78CC00","#7B71C5"])
      .dimension(divTypeDim)
      .group(divTypeGroup)
      .elasticX(true);
    
    //divisionTypechart.render();


    dayTypechart
      .width(300)
      .height(300)
      .ordinalColors(["#56B2EA","#E064CD","#F8B700","#78CC00","#7B71C5"])
      .dimension(dayTypeDim)
      .group(dayTypeGroup)
      .elasticX(true);

    hitslineChart
       .width(1000).height(300)
       .dimension(dateDim)
       .group(status_Re,"Readmission")
       .stack(status_Dis,"Discharge")
       //.stack(status_Avg,"Rate(%)")   
       .renderArea(true)
       .x(d3.time.scale().domain([minDate,maxDate]))
       .brushOn(true)
       .legend(dc.legend().x(50).y(10).itemHeight(13).gap(5))
       .renderHorizontalGridLines(true)
       .yAxisLabel("Hits per day");


    var datatable   = dc.dataTable("#dc-data-table");
    datatable
        .dimension(dateDim)
        .group(function(d) {return d.Year;})
        // dynamic columns creation using an array of closures
        .columns([
            function(d) { return d.date.getDate() + "/" + (d.date.getMonth() + 1) + "/" + d.date.getFullYear(); },
            function(d) {return d.Readmission;},
            function(d) {return d.Discharge;},
            function(d) {return numberFormat(d.Rate);},        
        ]);

    dc.renderAll();



});

</script>

</div>
</body>
</html>